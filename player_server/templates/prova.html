<!doctype html>
<html lang="en">
<head>
 
<title>A jQuery Drag-and-Drop Number Cards Game</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href={{ url_for('static', filename='style.css') }}>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
 
<script type="text/javascript">
$( init );

var player_server_port = location.port;
var game_status = 0;
var my_turn = 0;

var stopPollingGames = 0;
var banco = new Array()
function init() {
  // Create the pile of shuffled cards  
}

//$("#cardPile div").draggable( "disable" );

//funzione che chiedeIlBanco al serverino sottostante e lo mostra nella GUI
function chiediBanco() {
  console.log("chiedi banco")
  $.ajax({
    url: 'http://localhost:'+ player_server_port +'/banco',
    type: "GET",
    dataType: "json",
    success: function (data) {
      var banco = data;
      var flag = false;
      askPlayerCards();
      $('#cardSlots').html('');
        for (var i=0; i<banco.length;i++){
          if (flag == false){
            $('<div>' + i + '</div>').data( 'number', i ).appendTo( '#cardSlots' ).droppable( {
              accept: '#cardPile div',
              hoverClass: 'hovered',
              drop: handleCardDrop
            });
            $('<div>' + banco[i].event + '</div>').data( 'number', i).attr( 'id', 'primacarta' ).appendTo( '#cardSlots' )
            z = i+1
            $('<div>' + z + '</div>').data( 'number', z ).appendTo( '#cardSlots' ).droppable( {
              accept: '#cardPile div',
              hoverClass: 'hovered',
              drop: handleCardDrop
              });
            flag = true;
          }
          else if(flag == true) {
            console.log("else")
            $('<div>' + banco[i].event + '</div>').data( 'number', i ).attr( 'id', 'primacarta' ).appendTo( '#cardSlots' )
            y=i+1
            $('<div>' + y + '</div>').data( 'number', y).appendTo( '#cardSlots' ).droppable( {
              accept: '#cardPile div',
              hoverClass: 'hovered',
              drop: handleCardDrop
            });
          }
        } 
    }
  });
}

  function chiediMano(){
  $('#cardPile').html('');
    $.ajax({
  url: 'http://localhost:'+ player_server_port +'/mano',
  type: "GET",
  dataType: "json",
  success: function (data) {
    var numbers = data;
    for ( var i=0; i<numbers.length; i++ ) {
      $('<div>' + numbers[i].event + '</div>').data( 'card_id', numbers[i].card_id ).attr( 'id', 'card'+numbers[i] ).appendTo( '#cardPile' ).draggable( {
      containment: '#content',
      stack: '#cardPile div',
      cursor: 'move',
      revert: true
    } );
  }
}
})
}
function handleCardDrop( event, ui ) {
    ui.draggable.draggable( 'disable' );
    $(this).droppable( 'disable' );
    ui.draggable.position( { of: $(this), my: 'left top', at: 'left top' } );
    ui.draggable.draggable( 'option', 'revert', false );
    playCard(ui.draggable.data( 'card_id' ),$(this).data( 'number' ));
    console.log($(this).data( 'number' ));
    console.log(ui.draggable.data( 'card_id' ));
  } 
  </script>
 
</head>
<body>
 <table align="center" id="form">
 <form method="post" >
  <tr>
    <td colspan="2" align="center"><b>Registrazione al servizio<br>Tutti i campi sono obbligatori</b></td>
  </tr>
  <tr>
    <td><b>Nome</b></td>
    <td><input type="text" name="nome" id="inputtext"></td>
  </tr><tr><td> <input type="button" value="Registrati" id="submit"></td><!--<td><input type="button" value="Reset" id="reset"></td>--></tr></table>
</form>
<div id="creap" style="display: none;" align="center">
    <table id="creapartita">
      <tr><td>Numero di giocatori</td><td><input type='text' id='n_players'></td>
    </table>
    <input type='button' id='createG' value='createGame'>
  </div>
<div id="partite" style="display: none;" align="center">
  </div>
<div id="content">
  <div id="other_players" 
       style="
              display: none;
              width: inherit;
              height: 120px;
              padding: 20px;
              border: 2px solid #333;
              margin: 0 0 30px 0;
              -moz-border-radius: 10px;
              -webkit-border-radius: 10px;
              border-radius: 10px;
              -moz-box-shadow: 0 0 .3em rgba(0, 0, 0, .8);
              -webkit-box-shadow: 0 0 .3em rgba(0, 0, 0, .8);
              box-shadow: 0 0 .3em rgba(0, 0, 0, .8);">
  </div>
  <div id="cardPile" style="display: none;"> </div>
  <div id="cardSlots" style="display: none;"> </div>
 
  
 </div>
 <script>

 /*recuper il numero di carte degli altri giocatori*/
 function askPlayerCards(){
        console.log("asking for other player cards")
        $(function() {
          callAjax();
        });
        var varajax;
        function callAjax() {
          varajax = $.ajax({
              cache: false,
              url: 'http://localhost:'+player_server_port+'/playerCards',        
              dataType: 'json',  
              success: function(data) {
                if( game_status == 1 ){
                  $('#other_players').empty();
                  $('#other_players, .carta_p').show();
                  for( key in data ){
                    console.log(data[key]);
                    $("#other_players").append("<div class='carta_p' style='float:left;'>"+ data[key] +"</div>");
                  }
                }
                console.log(data);
              }
          });
        }
  }

 $( "#reset" ).click(function() {
    $("#inputtext").val("");
  });
 $( "#submit" ).click(function() {
    var bla = $("#inputtext").val();  
    $.ajax({
    url: 'http://localhost:'+ player_server_port +'/createPlayer/'+bla,
    type: "POST",
    dataType: "text",
    success: function (data) {
      console.log(data)
      $("#form").hide();
      showGames();
      $("#partite").show();
    },
    error: function(xhr, textStatus, errorThrown){
      if( textStatus == "error" )
       $("#inputtext").css({'background-color' : 'lightcoral'});
       console.log(textStatus);
       //console.log(errorThrown)
    }
  })
});
function showGames(){
    var games
    var my_delay = 1000;
      $(function() {
        callAjax();
      });
    var varajax;
    function callAjax(){
    varajax = $.ajax({
      url: 'http://localhost:'+ player_server_port +'/gamesList',
      type: "GET",
      dataType: "json",
    success: function (data) {
      setTimeout(callAjax, my_delay);
      games = data
      if (games['zero'] == 0) {
        $('#partite').html('');
        $('#partite').html('<h2>non ci sono partite</h2><input type="button" id="createGame" value="createGame">');
        $("#createGame").click(function() {
          console.log("ciao");
          $("#creap").show();
          $("#partite").hide();
        });
      }
      else{
        $('#partite').html('');
        $('#partite').html('<table id="mytable"><tr><td>ID</td><td>CREATOR</td><td>PLAYER_N</td></tr></table><input type="button" id="createGame" value="createGame">');
        $("#createGame").click(function() {
          console.log("ciao");
          $("#creap").show();
          $("#partite").hide();
        });
        for ( var i=0; i<games.length; i++ ) {
          $('#mytable tr:last').after("<tr><td><a onclick=joinGames("+games[i].game_id+")>"+games[i].game_id+"</a></td><td>"+games[i].creator.username+"</td><td>"+games[i].player_n+"</td></tr>");
      }
    }
    }
  })
  if (stopPollingGames == 1){
    varajax.abort();
  }
  }
}
$( "#createG" ).click(function() {
    var nplayers = $("#n_players").val();
    stopPollingGames = 1;
    $.ajax({
    url: 'http://localhost:'+ player_server_port +'/createGame/'+nplayers,
    type: "POST",
    dataType: "text",
    success: function (data) {
      console.log(data)
      $("#creap").hide()
      $("#partite").show()
      pollingAjaxsg();
    }
  })
});
function joinGames(game_id){
  stopPollingGames = 1;
  $.ajax({
    url: 'http://localhost:'+ player_server_port +'/joinGame/'+game_id,
    type: "PUT",
    dataType: "text",
    success: function (data) {
      pollingAjaxsg(); 
    }
  });
}
function playCard(card_id,position){
  $.ajax({
    url: 'http://localhost:'+player_server_port+'/playCard/'+card_id+'/'+position,
    type: "PUT",
    dataType: "text",
    success: function (data) {
      if( my_turn == 1 )
        my_turn = 0;
      pollingAjaxtr();
    }
  });
  chiediMano();
}
function pollingAjaxsg(){
  $('#partite').html('');
      $('#partite').html('<h2>ATTENDERE INIZIO PARTITA...</h2>');
      var my_delay = 1000;
      $(function() {
        callAjax();
      });
      var varajax;
      function callAjax() {
        varajax = $.ajax({
            cache: false,    
            url: 'http://localhost:'+ player_server_port +'/gameStatus',        
            dataType: 'json',  
            success: function(data) {
              if( my_turn == 0 )
                setTimeout(callAjax, my_delay);
              if(data['status'] == 1){
                 game_status = data['status'];
                 chiediBanco();
                 chiediMano();
                 $('#other_players').show();
                 $("#cardPile").show();
                 $("#cardSlots").show();
                 pollingAjaxtr();
              }
            }
        });
        if (game_status==1){
          varajax.abort();
        }
      }
}
function pollingAjaxtr(){
  $('#partite').html('');
      $('#partite').html('<h2>ATTENDERE IL PROPRIO TURNO...</h2>');
      var my_delay = 1000;
      $(function() {
        callAjax();
      });
      var varajax;
      function callAjax() {
        varajax = $.ajax({
            cache: false,
            url: 'http://localhost:'+player_server_port+'/turnStatus',        
            dataType: 'json',  
            success: function(data) {
              if( my_turn == 0 )
                setTimeout(callAjax, my_delay);
              chiediBanco();
              if(data['turn'] == 1){
                 my_turn = 1;
                 $("#cardPile div").draggable( "enable" );
                 $('#partite').html('');
                 $('#partite').html('<h2>E IL TUO TURNO</h2>');
              }
              else{
                 my_turn = 0;
                 $("#cardPile div").draggable( "disable" );
                 $('#partite').html('');
                 $('#partite').html('<h2>ATTENDERE IL PROPRIO TURNO...</h2>');
              }
            }
        });
      }
}
 </script>
</body>
</html>