<!doctype html>
<html lang="en">
<head>
 
<title>A jQuery Drag-and-Drop Number Cards Game</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href={{ url_for('static', filename='style.css') }}>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
 
<script type="text/javascript">
$( init );
var stopPollingGames = 0;
var stopPollingBa = 0;
var banco = new Array();
var bancoPreDoubt = new Array();
var player_server_port = location.port;
var game_status = 0;
var my_turn = 0;
var prevHandLenght = 0;
var mustRefreshBanco = false;

function init() {
  // Create the pile of shuffled cards  
}
//funzione che chiedeIlBanco al serverino sottostante e lo mostra nella GUI
function mostraDateBanco() {
  console.log("mostra banco");
  $('#cardSlots').html('');
  var flag = false;
  for (var i=0; i<bancoPreDoubt.length;i++){
    if (flag ==false){
      $('<div>' + i + '</div>').data( 'number', i ).appendTo( '#cardSlots' ).droppable( {
        accept: '#cardPile div',
        hoverClass: 'hovered',
        drop: handleCardDrop
      });
      $('<div>' + bancoPreDoubt[i].year + '</div>').data( 'number', i).attr( 'id', 'primacarta' ).appendTo( '#cardSlots' )
      z = i+1
      $('<div>' + z + '</div>').data( 'number', z ).appendTo( '#cardSlots' ).droppable( {
        accept: '#cardPile div',
        hoverClass: 'hovered',
        drop: handleCardDrop
        });
      flag = true;
    }
    else if(flag == true) {
      console.log("else")
      $('<div>' + bancoPreDoubt[i].year + '</div>').data( 'number', i ).attr( 'id', 'primacarta' ).appendTo( '#cardSlots' )
      y=i+1
      $('<div>' + y + '</div>').data( 'number', y).appendTo( '#cardSlots' ).droppable( {
        accept: '#cardPile div',
        hoverClass: 'hovered',
        drop: handleCardDrop
      });
    }
  }
  bancoPreDoubt = banco;
  mustRefreshBanco = true;
}

  function chiediMano(){
    $.ajax({
  url: 'http://localhost:'+ player_server_port +'/mano',
  type: "GET",
  dataType: "json",
  success: function (data) {
    numbers = data
    //console.log("prevHandLenght"+prevHandLenght);
    //console.log("numbers.length"+numbers.length);
    if (prevHandLenght != numbers.length){
      $('#cardPile').html('');
      for ( var i=0; i<numbers.length; i++ ) {
        $('<div>' + numbers[i].event + '</div>').data( 'card_id', numbers[i].card_id ).attr( 'id', 'card'+numbers[i] ).appendTo( '#cardPile' ).draggable( {
        containment: '#content',
        stack: '#cardPile div',
        cursor: 'move',
        revert: true
      } );
      prevHandLenght = numbers.length
    }
  }
}
})
}
function handleCardDrop( event, ui ) {
    ui.draggable.draggable( 'disable' );
    $(this).droppable( 'disable' );
    ui.draggable.position( { of: $(this), my: 'left top', at: 'left top' } );
    ui.draggable.draggable( 'option', 'revert', false );
    playCard(ui.draggable.data( 'card_id' ),$(this).data( 'number' ))
    console.log($(this).data( 'number' ))
    console.log(ui.draggable.data( 'card_id' ))
  } 
  </script>
 
</head>
<body>
 <table align="center" id="form">
 <form method="post" >
  <tr>
    <td colspan="2" align="center"><b>Registrazione al servizio<br>Tutti i campi sono obbligatori</b></td>
  </tr>
  <tr>
    <td><b>Nome</b></td>
    <td><input type="text" name="nome" id="inputtext"></td>
  </tr><tr><td> <input type="button" value="Registrati" id="submit"></td><!--<td><input type="button" value="Reset" id="reset"></td>--></tr></table>
</form>
<div id="creap" style="display: none;" align="center">
    <table id="creapartita">
      <tr><td>Numero di giocatori</td><td><input type='text' id='n_players'></td>
    </table>
    <input type='button' id='createG' value='createGame'>
  </div>
<div id="partite" style="display: none;" align="center">
  </div>
<div id="content">
 
  <div id="cardPile" style="display: none;"> </div>
  <input type="button" id ="dubbio" value="Dubbio" align="center" style="display: none;">
  <div id="cardSlots" style="display: none;"> </div>
 
  
 </div>
 <script>
 var stopPollingTr = 0;
 var player_server_port = location.port;
 $( "#reset" ).click(function() {
    $("#inputtext").val("")
});
 $( "#submit" ).click(function() {
    var bla = $("#inputtext").val();  
    $.ajax({
    url: 'http://localhost:'+ player_server_port +'/createPlayer/'+bla,
    type: "POST",
    dataType: "text",
    success: function (data) {
      console.log(data)
      $("#form").hide();
      showGames();
      $("#partite").show();
    },
    error: function(xhr, textStatus, errorThrown){
      if( textStatus == "error" )
       $("#inputtext").css({'background-color' : 'lightcoral'});
       console.log(textStatus);
       //console.log(errorThrown)
    }
  })
});
function showGames(){
    var games
    var my_delay = 1000;
      $(function() {
        callAjax();
      });
    var varajax;
    function callAjax(){
    varajax = $.ajax({
      url: 'http://localhost:'+ player_server_port +'/gamesList',
      type: "GET",
      dataType: "json",
    success: function (data) {
      setTimeout(callAjax, my_delay);
      games = data
      if (games['zero'] == 0) {
        $('#partite').html('');
        $('#partite').html('<h2>non ci sono partite</h2><input type="button" id="createGame" value="createGame">');
        $("#createGame").click(function() {
          console.log("ciao");
          $("#creap").show();
          $("#partite").hide();
        });
      }
      else{
        $('#partite').html('');
        $('#partite').html('<table id="mytable"><tr><td>ID</td><td>CREATOR</td><td>PLAYER_N</td></tr></table><input type="button" id="createGame" value="createGame">');
        $("#createGame").click(function() {
          console.log("ciao");
          $("#creap").show();
          $("#partite").hide();
        });
        for ( var i=0; i<games.length; i++ ) {
          $('#mytable tr:last').after("<tr><td><a onclick=joinGames("+games[i].game_id+")>"+games[i].game_id+"</a></td><td>"+games[i].creator.username+"</td><td>"+games[i].player_n+"</td></tr>");
      }
    }
    }
  })
  if (stopPollingGames == 1){
    varajax.abort();
  }
  }
}
$( "#createG" ).click(function() {
    var nplayers = $("#n_players").val();
    stopPollingGames = 1;
    $.ajax({
    url: 'http://localhost:'+ player_server_port +'/createGame/'+nplayers,
    type: "POST",
    dataType: "text",
    success: function (data) {
      console.log(data)
      $("#creap").hide()
      $("#partite").show()
      pollingAjaxsg();
      pollingAjaxdb();
    }
  })
});
$( "#dubbio" ).click(function() {
    $.ajax({
    url: 'http://localhost:'+ player_server_port +'/doubt',
    type: "PUT",
    dataType: "text",
    success: function (data) {
    }
  })
});
function joinGames(game_id){
  stopPollingGames = 1;
  $.ajax({
    url: 'http://localhost:'+ player_server_port +'/joinGame/'+game_id,
    type: "PUT",
    dataType: "text",
    success: function (data) {
      pollingAjaxsg(); 
      pollingAjaxdb();
    }
  });
}
function playCard(card_id,position){
  $.ajax({
    url: 'http://localhost:'+player_server_port+'/playCard/'+card_id+'/'+position,
    type: "PUT",
    dataType: "text",
    success: function (data) {
      stopPollingTr = 0;
      pollingAjaxtr();
      pollingAjaxdb();
    }
  });
  chiediMano()
}
function pollingAjaxsg(){
  $('#partite').html('');
      $('#partite').html('<h2>ATTENDERE INIZIO PARTITA...</h2>');
      var my_delay = 1000;
      var termina;
      $(function() {
        callAjax();
      });
      var varajax;
      function callAjax() {
        varajax = $.ajax({
            cache: false,    
            url: 'http://localhost:'+ player_server_port +'/gameStatus',        
            dataType: 'json',  
            success: function(data) {
              setTimeout(callAjax, my_delay);
              if(data['status'] == 1){
                 termina = data['status'];
                 chiediMano();
                 $("#cardPile").show();
                 $("#dubbio").show();
                 $("#cardSlots").show();
                 pollingAjaxtr();
                 pollingAjaxba();
              }
            }
        });
        if (termina==1){
          varajax.abort();
        }
      }
}
function pollingAjaxtr(){
  $('#partite').html('');
    $('#partite').html('<h2>ATTENDERE IL PROPRIO TURNO...</h2>');
    var my_delay = 1000;
    $(function() {
      callAjax();
    });
    var varajax;
    function callAjax() {
      varajax = $.ajax({
        cache: false,
        url: 'http://localhost:'+player_server_port+'/turnStatus',        
        dataType: 'json',  
        success: function(data) {
          setTimeout(callAjax, my_delay);
          if(data['turn'] == 1){
             $('#partite').html('');
             $('#partite').html('<h2>E IL TUO TURNO</h2>');
             chiediMano()
             $("#cardPile div").draggable( "enable" );
             stopPollingTr = 1;
          }
          else{
             $('#partite').html('');
             $('#partite').html('<h2>ATTENDERE IL PROPRIO TURNO...</h2>');
             $("#cardPile div").draggable( "disable" );
             chiediMano()
          }
        }
      });
       if (stopPollingTr==1){
        varajax.abort();
      }
  }
}

function pollingAjaxdb(){
  var my_delay = 1000;
  $(function() {
    callAjax();
  });
  var varajax;
  function callAjax() {
    varajax = $.ajax({
      cache: false,    
      url: 'http://localhost:'+ player_server_port +'/doubtStatus',        
      dataType: 'json',  
      success: function(data) {
        setTimeout(callAjax, my_delay);
        if(data['doubt'] != 0){ //Entro solo se qualcuno ha dubitato
          stopPollingBa = 1
          mostraDateBanco();
          setTimeout(function restartPollingBa() { stopPollingBa = 0; pollingAjaxba(); }, 100000);
          if(data['status']== 1) { //Dubitato Male
            if (stopPollingTr==1) {
              stopPollingTr = 0
              pollingAjaxtr();
            }
            console.log("IL GIOCATORE "+data['doubt']+" HA DUBITATO " +"MALE");
          }
          else{ //Dubitato bene
            console.log("IL GIOCATORE "+data['doubt']+" HA DUBITATO " +"BENE");
          }
        }
      }
    });
  }
}

//funzione di polling per il banco
function pollingAjaxba(){
  if (stopPollingBa != 1) {
    console.log("Polling Banco");
    var my_delay = 1000;
    $(function() {
      callAjax();
    });
    var varajax;
    function callAjax() {
      varajax = $.ajax({
        url: 'http://localhost:'+ player_server_port +'/banco',
        type: "GET",
        dataType: "json",
        success: function (data) {
          setTimeout(callAjax, my_delay);
          if (banco.length == data.length && banco.length!=0 && !mustRefreshBanco) //Per evitare refresh continui
            return ;
          banco = data;
          if (banco.length > bancoPreDoubt.length)
            bancoPreDoubt = data;
          var flag = false;
          $('#cardSlots').html('');
          for (var i=0; i<banco.length;i++){
            if (flag ==false){
              $('<div>' + i + '</div>').data( 'number', i ).appendTo( '#cardSlots' ).droppable( {
                accept: '#cardPile div',
                hoverClass: 'hovered',
                drop: handleCardDrop
              });
              $('<div>' + banco[i].event + '</div>').data( 'number', i).attr( 'id', 'primacarta' ).appendTo( '#cardSlots' )
              z = i+1
              $('<div>' + z + '</div>').data( 'number', z ).appendTo( '#cardSlots' ).droppable( {
                accept: '#cardPile div',
                hoverClass: 'hovered',
                drop: handleCardDrop
                });
              flag = true;
            }
            else if(flag == true) {
              console.log("else")
              $('<div>' + banco[i].event + '</div>').data( 'number', i ).attr( 'id', 'primacarta' ).appendTo( '#cardSlots' )
              y=i+1
              $('<div>' + y + '</div>').data( 'number', y).appendTo( '#cardSlots' ).droppable( {
                accept: '#cardPile div',
                hoverClass: 'hovered',
                drop: handleCardDrop
              });
            }
          }
          mustRefreshBanco = false;
        }
      });
    }
  } //Chiude if stopPollingBa!=1
  else
    varajax.abort();
}
 </script>
</body>
</html>